<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daftar â€” SkinCare.id</title>
  <link rel="stylesheet" href="/assets/css/resgister.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="logo">
        <div class="logo-icon">ğŸ’§</div>
        <h1 class="logo-text">SkinCare.id</h1>
      </div>

      <h2 class="card-title">Buat Akun Baru</h2>
      <p class="subtitle">Daftar untuk mulai perjalanan perawatan kulitmu âœ¨</p>

      <form id="registerForm" novalidate>
        <div class="form-group">
          <label for="name">Nama Lengkap</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            placeholder="Nama lengkap"
          />
        </div>

        <div class="form-group">
          <label for="email">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            autocomplete="email"
            required
            placeholder="contoh@email.com"
          />
        </div>

        <div class="form-group">
          <label for="password">Kata Sandi</label>
          <div class="password-wrapper">
            <input
              type="password"
              id="password"
              name="password"
              autocomplete="new-password"
              required
              placeholder="Minimal 8 karakter"
            />
            <button type="button" class="toggle-password">ğŸ‘ï¸</button>
          </div>
        </div>

        <div class="form-group">
          <label for="confirm_password">Konfirmasi Kata Sandi</label>
          <div class="password-wrapper">
            <input
              type="password"
              id="confirm_password"
              name="confirm_password"
              required
              placeholder="Ulangi kata sandi"
            />
            <button type="button" class="toggle-password">ğŸ‘ï¸</button>
          </div>
        </div>

        <button type="submit" class="btn-primary">Daftar</button>
      </form>

      <div class="divider">
        <span>atau</span>
      </div>

      <div class="social-login">
        <button class="btn-social btn-google">Google</button>
        <button class="btn-social btn-facebook">Facebook</button>
      </div>

      <div class="signup-prompt">
        Sudah punya akun? <a href="login.html" class="signup-link">Masuk</a>
      </div>
    </div>

    <div class="footer-note">
      Â© 2025 SkinCare.id â€¢ Privasi & Ketentuan
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // REGISTER FORM
document.getElementById("registerForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  e.stopPropagation();

  const name = this.name.value.trim();
  const email = this.email.value.trim();
  const password = this.password.value;
  const confirm = this.confirm_password.value;

  // VALIDASI (sama seperti sebelumnya)
  if (!name || !email || !password || !confirm) {
    alert("âŒ Semua field wajib diisi");
    return;
  }
  if (password.length < 8) {
    alert("âŒ Password minimal 8 karakter");
    return;
  }
  if (password !== confirm) {
    alert("âŒ Konfirmasi password tidak cocok");
    return;
  }

  // LOADING
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = "â³ Mendaftarkan...";
  submitBtn.disabled = true;

  try {
    console.log("ğŸš€ Memulai registrasi...");

    // ========== 1. SIGN UP ==========
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          full_name: name,
          email: email
        }
      }
    });

    if (authError) {
      console.error("Auth Error:", authError);
      throw new Error(`Auth Error: ${authError.message}`);
    }

    if (!authData.user) {
      throw new Error("User tidak terbuat");
    }

    const userId = authData.user.id;
    console.log("âœ… Auth berhasil! User ID:", userId);

    // ========== 2. INSERT PROFILE ==========
    console.log("ğŸ”„ Menyimpan profile...");
    
    // Tunggu sebentar sebelum insert (kadang perlu delay)
    await new Promise(resolve => setTimeout(resolve, 500));

    const { data: profileData, error: profileError } = await supabase
      .from("profiles")
      .insert([
        {
          id: userId,
          nama: name,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }
      ])
      .select()
      .single();

    if (profileError) {
      console.error("âŒ Profile Error:", profileError);
      
      // Coba alternatif: Update jika sudah ada
      console.log("ğŸ”„ Coba update profile...");
      const { error: updateError } = await supabase
        .from("profiles")
        .update({ 
          nama: name,
          updated_at: new Date().toISOString()
        })
        .eq("id", userId);
      
      if (updateError) {
        console.error("âŒ Update juga gagal:", updateError);
        
        // SIMPAN DI LOCALSTORAGE SEBAGAI BACKUP
        localStorage.setItem('pending_profile', JSON.stringify({
          id: userId,
          nama: name,
          email: email,
          created_at: new Date().toISOString()
        }));
        
        console.warn("âš ï¸ Profile disimpan di localStorage sebagai backup");
      }
    } else {
      console.log("âœ… Profile berhasil disimpan:", profileData);
    }

    // ========== 3. SUKSES ==========
    console.log("ğŸ‰ Registrasi selesai!");
    
    alert(`âœ… Registrasi berhasil!\n\nğŸ“§ Email: ${email}\nğŸ‘¤ Nama: ${name}\n\nSilakan cek email untuk verifikasi.`);
    
    setTimeout(() => {
      window.location.href = "login.html?registered=true&email=" + encodeURIComponent(email);
    }, 2000);

  } catch (error) {
    console.error("ğŸ’¥ ERROR:", error);
    
    // ERROR MESSAGE YANG LEBIH BAik
    let userMessage = "Registrasi gagal: ";
    
    if (error.message.includes("duplicate key")) {
      userMessage = "Email sudah terdaftar!";
    } else if (error.message.includes("profiles")) {
      userMessage = "Error database. Hubungi administrator.";
    } else if (error.message.includes("auth")) {
      userMessage = "Error autentikasi: " + error.message;
    } else {
      userMessage = error.message;
    }
    
    alert("âŒ " + userMessage);
    
    // RESET BUTTON
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
});
</script>

</body>
</html>
