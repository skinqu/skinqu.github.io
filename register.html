<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daftar â€” SkinCare.id</title>
  <link rel="stylesheet" href="/assets/css/resgister.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="logo">
        <div class="logo-icon">ğŸ’§</div>
        <h1 class="logo-text">SkinCare.id</h1>
      </div>

      <h2 class="card-title">Buat Akun Baru</h2>
      <p class="subtitle">Daftar untuk mulai perjalanan perawatan kulitmu âœ¨</p>

      <form id="registerForm" novalidate>
        <div class="form-group">
          <label for="name">Nama Lengkap</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            placeholder="Nama lengkap"
          />
        </div>

        <div class="form-group">
          <label for="email">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            autocomplete="email"
            required
            placeholder="contoh@email.com"
          />
        </div>

        <div class="form-group">
          <label for="password">Kata Sandi</label>
          <div class="password-wrapper">
            <input
              type="password"
              id="password"
              name="password"
              autocomplete="new-password"
              required
              placeholder="Minimal 8 karakter"
            />
            <button type="button" class="toggle-password">ğŸ‘ï¸</button>
          </div>
        </div>

        <div class="form-group">
          <label for="confirm_password">Konfirmasi Kata Sandi</label>
          <div class="password-wrapper">
            <input
              type="password"
              id="confirm_password"
              name="confirm_password"
              required
              placeholder="Ulangi kata sandi"
            />
            <button type="button" class="toggle-password">ğŸ‘ï¸</button>
          </div>
        </div>

        <button type="submit" class="btn-primary">Daftar</button>
      </form>

      <div class="divider">
        <span>atau</span>
      </div>

      <div class="social-login">
        <button class="btn-social btn-google">Google</button>
        <button class="btn-social btn-facebook">Facebook</button>
      </div>

      <div class="signup-prompt">
        Sudah punya akun? <a href="login.html" class="signup-link">Masuk</a>
      </div>
    </div>

    <div class="footer-note">
      Â© 2025 SkinCare.id â€¢ Privasi & Ketentuan
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // INIT SUPABASE
const SUPABASE_URL = "https://bnawrgrhmvkyzkixlbkc.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuYXdyZ3JobXZreXpraXhsYmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NDA2MDUsImV4cCI6MjA4MTIxNjYwNX0.msUs2RMnJqAs086mkV4FTNIEOHb_3i-hGX5B0sWtolg";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// TOGGLE PASSWORD
document.querySelectorAll('.toggle-password').forEach(btn => {
  btn.addEventListener('click', function () {
    const input = this.previousElementSibling;
    input.type = input.type === 'password' ? 'text' : 'password';
    this.textContent = input.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
  });
});

// REGISTER FORM
document.getElementById("registerForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  
  const name = this.name.value.trim();
  const email = this.email.value.trim();
  const password = this.password.value;
  const confirm = this.confirm_password.value;

  // VALIDASI
  if (!name || !email || !password || !confirm) {
    alert("âŒ Semua field wajib diisi");
    return;
  }
  if (password.length < 8) {
    alert("âŒ Password minimal 8 karakter");
    return;
  }
  if (password !== confirm) {
    alert("âŒ Konfirmasi password tidak cocok");
    return;
  }

  // LOADING STATE
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = "â³ Mendaftarkan...";
  submitBtn.disabled = true;

  try {
    console.log("=== REGISTRASI DIMULAI ===");
    
    // ========== METODE 1: SIGNUP DENGAN AUTO-LOGIN ==========
    console.log("1. Melakukan signUp...");
    
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          full_name: name
        }
      }
    });

    if (authError) {
      console.error("Auth Error:", authError);
      throw new Error(`Auth: ${authError.message}`);
    }

    console.log("2. SignUp berhasil, User ID:", authData.user?.id);
    
    if (!authData.user) {
      throw new Error("User tidak terbuat");
    }

    const userId = authData.user.id;
    
    // ========== TRICK: LOGIN DULU UNTUK DAPAT SESSION ==========
    console.log("3. Melakukan login untuk mendapatkan session...");
    
    const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (loginError) {
      console.warn("Login otomatis gagal (mungkin butuh verifikasi):", loginError);
      // Lanjutkan saja, mungkin user perlu verifikasi email dulu
    } else {
      console.log("4. Login berhasil, session aktif");
    }

    // ========== INSERT KE PROFILES ==========
    console.log("5. Menyimpan ke tabel profiles...");
    
    // Tunggu sebentar untuk memastikan user ready
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Coba dengan RETRY mechanism
    let profileSaved = false;
    let retryCount = 0;
    const maxRetries = 3;
    
    while (!profileSaved && retryCount < maxRetries) {
      try {
        console.log(`   Percobaan ke-${retryCount + 1}...`);
        
        const { data: profileResult, error: profileError } = await supabase
          .from("profiles")
          .insert([
            {
              id: userId,
              nama: name,
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString()
            }
          ])
          .select()
          .single();
        
        if (profileError) {
          console.warn(`   Percobaan ${retryCount + 1} gagal:`, profileError.message);
          
          if (profileError.message.includes("violates row-level security policy")) {
            console.log("   RLS Policy error, coba dengan method alternatif...");
            
            // Alternatif: Update jika sudah ada (mungkin terbuat otomatis)
            const { error: updateError } = await supabase
              .from("profiles")
              .update({ 
                nama: name,
                updated_at: new Date().toISOString()
              })
              .eq("id", userId);
              
            if (!updateError) {
              console.log("   âœ… Berhasil update existing profile");
              profileSaved = true;
              break;
            }
          }
          
          retryCount++;
          await new Promise(resolve => setTimeout(resolve, 1000)); // Tunggu 1 detik
        } else {
          console.log("   âœ… Profile berhasil disimpan:", profileResult);
          profileSaved = true;
          break;
        }
      } catch (retryError) {
        console.error("   Error dalam retry:", retryError);
        retryCount++;
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
    
    if (!profileSaved) {
      console.warn("   âš ï¸ Gagal menyimpan profile setelah beberapa percobaan");
      console.log("   Menyimpan data ke localStorage untuk sinkronisasi nanti...");
      
      localStorage.setItem('pending_profile_sync', JSON.stringify({
        user_id: userId,
        nama: name,
        email: email,
        timestamp: new Date().toISOString()
      }));
    }

    // ========== SUKSES ==========
    console.log("ğŸ‰ PROSES REGISTRASI SELESAI!");
    
    // Tampilkan pesan sukses
    alert(`âœ… Registrasi berhasil!\n\nğŸ“§ Email: ${email}\nğŸ‘¤ Nama: ${name}\n\nSilakan cek email Anda untuk verifikasi akun.`);
    
    // Logout untuk keamanan (karena kita login otomatis tadi)
    await supabase.auth.signOut();
    
    // Redirect ke login
    setTimeout(() => {
      window.location.href = "login.html?registered=true&email=" + encodeURIComponent(email);
    }, 3000);

  } catch (error) {
    console.error("ğŸ’¥ ERROR REGISTRASI:", error);
    
    // Reset button
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    
    // Tampilkan error yang user-friendly
    let errorMessage = "Registrasi gagal: ";
    
    if (error.message.includes("User already registered")) {
      errorMessage = "Email sudah terdaftar!";
    } else if (error.message.includes("duplicate key")) {
      errorMessage = "Email sudah terdaftar!";
    } else if (error.message.includes("profiles")) {
      errorMessage = "Error sistem. Silakan coba lagi nanti.";
    } else {
      errorMessage += error.message;
    }
    
    alert("âŒ " + errorMessage);
  }
});

// Fungsi untuk sinkronisasi profile jika ada di localStorage
async function syncPendingProfile() {
  const pending = localStorage.getItem('pending_profile_sync');
  if (pending) {
    try {
      const profileData = JSON.parse(pending);
      console.log("ğŸ”„ Mencoba sinkronisasi pending profile...", profileData);
      
      const { data, error } = await supabase
        .from("profiles")
        .upsert({
          id: profileData.user_id,
          nama: profileData.nama,
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'id'
        })
        .select();
        
      if (!error) {
        console.log("âœ… Pending profile berhasil disinkronisasi");
        localStorage.removeItem('pending_profile_sync');
      }
    } catch (e) {
      console.error("Error sinkronisasi:", e);
    }
  }
}

// Cek dan sinkron saat page load
document.addEventListener('DOMContentLoaded', syncPendingProfile);
</script>

</body>
</html>
