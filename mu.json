let raw = $json.output ?? $json;

// ================= CLEAN JSON STRING =================
if (typeof raw === 'string') {
  raw = raw
    .replace(/```json/gi, '')
    .replace(/```/g, '')
    .replace(/^json\s*/i, '')
    .trim();
}

let products;
try {
  products = typeof raw === 'string' ? JSON.parse(raw) : raw;
} catch (e) {
  return [{
    json: {
      error: 'JSON tidak valid',
      raw_text: raw,
      error_message: e.message
    }
  }];
}

// ================= PASTIKAN ARRAY =================
if (!Array.isArray(products)) {
  products = [products];
}

// ================= IMAGE MAP (FACEWASH WOMEN) =================
const imageMap = {
  "Implora Facewash Women":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/implora_facewash_women.jpg",

  "Somethinc Facewash Women":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/somethinginc_facewash_women.jpg",

  "Azrine Facewash Women":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/azrine_facewash_women.jpg",

  "Scarlett Facewash Women":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/scarlett_facewash_women.jpg",

  "Skintific Facewash Women":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/skintific_facewash_women.jpg",

  "The Originote Facewash Women":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/the_originote_facewash_women.jpg",

  "Hanasui Facewash Women":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/hanasui_facewash_women.jpg",

  "Glad2Glow Facewash Women":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/glad2glow_facewash_women.jpg",

  "Emina Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/emina_facewash_woman.jpg",

  "Animate Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/animate_facewash_woman.jpg",

  "Acnes Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/acnes_facewash_woman.jpg",

  "Viva Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/viva_facewash_woman.jpg",

  "Nivea Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/nivea_facewash_women.jpg",

  "OMG Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/omg_facewash_woman.jpg",

  "Shinzui Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/shinzui_facewash_woman.jpg",

  "Garnier Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/garnier_facewash_woman.jpg",

  "Scora Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/scora_facewash_woman.jpg",

  "You Facewash Woman":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/facewash_women/you_facewash_woman.jpg",

    "Avoskin Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/avoskin_toner_men.jpg",

  "Azarine Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/azarine_toner_men.jpg",

  "Benings Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/benings_toner_men.jpg",

  "Centella Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/centela_toner_men.jpg",

  "Elvicto Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/elvicto_toner_men.jpg",

  "Kahf Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/kahf_toner_men.jpg",

  "Kelir Skin Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/kelirskin_toner_men.jpg",

  "N Pure Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/n_pure_toner_men.jpg",

  "R1 Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/r1_toner_men.jpg",

  "Skintific Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/skintific_toner_men.jpg",

  "The Face Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/the_face_toner_men.jpg",

  "White Inc Toner Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/toner_men/white_inc_toner_men.jpg",

    "Hanasui Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/hanasui_serum_men.jpg",

  "Heasel Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/heasel_serum_men.jpg",

  "Kahf Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/kahf_serum_men.jpg",

  "Menlab Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/menlab_serum_men.jpg",

  "Menyou Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/menyou_serum_men.jpg",

  "Moonlight Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/moonlight_serum_men.jpg",

  "MS Glow Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/msglow_serum_men.jpg",

  "R1 Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/r1_serum_men.jpg",

  "SYB Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/syb_serum_men.jpg",

  "Atallah Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/atallah_serum_men.jpg",

  "Barber Daily Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/barber_daily_serum_men.jpg",

  "Bromen Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/bromen_serum_men.jpg",

  "Clorismen Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/clorismen_serum_men.jpg",

  "Elvicto Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/serum_men/elvicto_serum_men.jpg",

    "Kelir Skin Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/kelirskin_moisturizer_men.jpg",

  "Man Shk Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/man_shk_moisturizer_men.jpg",

  "Menyou Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/menyou_moisturizer_men.jpg",

  "Minimalist Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/minimalist_moisturizer_men.jpg",

  "Moisture Softly Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/moisture_softly_moisturizer_men.jpg",

  "MS Glow Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/msglow_moisturizer_men.jpg",

  "Nivea Men Moisturizer":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/nivea_men_moisturizer_men.jpg",

  "Personafic Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/personafic_moisturizer_men.jpg",

  "Thipank Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/thipank_moisturizer_men.jpg",

  "Atallah Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/atallah_moisturizer_men.jpg",

  "Barber Daily Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/barber_daily_moisturizer_men.jpg",

  "Bromen Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/bromen_moisturizer_men.jpg",

  "Centela Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/centela_moisturizer_men.jpg",

  "Clorismen Serum Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/clorismen_serum_men.jpg",

  "Elvicto Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/elvicto_moisturizer_men.jpg",

  "Fyne Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/fyne_moisturizer_men.jpg",

  "Glad2Glow Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/glad2glow_moisturizer_men.jpg",

  "Heasel Moisturizer Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/moisturizer_men/heasel_moisturizer_men.jpg",

    "The Originote Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/the_originote_sunscreen_men.jpg",

  "R1 Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/r1_sunscreen_men.jpg",

  "Bromen Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/bromen_sunscreen_men.jpg",

  "MS Glow Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/ms_glow_sunscreen_men.jpg",

  "Wardah Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/wardah_sunscreen_men.jpg",

  "Gatsby Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/gatsby_sunscreen_men.jpg",

  "Skintific Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/skintific_sunscreen_men.jpg",

  "Azarine Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/azarine_sunscreen_men.jpg",

  "Cave Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/cave_sunscreen_men.jpg",

  "Scarlett Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/scarlett_sunscreen_men.jpg",

  "Hanasui Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/hanasui_sunscreen_men.jpg",

  "Kahf Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/kahf_sunscreen_men.jpg",

  "Implora Sunscreen Men":
    "https://bnawrgrhmvkyzkixlbkc.supabase.co/storage/v1/object/public/product-images/sunscreen_men/implora_sunscreen_men.jpg"

};

// ================= IMAGE MATCHING =================
function findMatchingImage(productName) {
  if (!productName || typeof productName !== 'string') return '';

  const lowerName = productName.toLowerCase();

  // Exact match
  for (const key of Object.keys(imageMap)) {
    if (key.toLowerCase() === lowerName) {
      return imageMap[key];
    }
  }

  // Partial match
  for (const [key, url] of Object.entries(imageMap)) {
    if (lowerName.includes(key.toLowerCase())) {
      return url;
    }
  }

  // Brand keyword mapping
  const brandMappings = {
    implora: "Implora Facewash Women",
    somethinginc: "Somethinc Facewash Women",
    azrine: "Azrine Facewash Women",
    scarlett: "Scarlett Facewash Women",
    skintific: "Skintific Facewash Women",
    originote: "The Originote Facewash Women",
    hanasui: "Hanasui Facewash Women",
    glad2glow: "Glad2Glow Facewash Women",
    emina: "Emina Facewash Woman",
    animate: "Animate Facewash Woman",
    acnes: "Acnes Facewash Woman",
    viva: "Viva Facewash Woman",
    nivea: "Nivea Facewash Woman",
    omg: "OMG Facewash Woman",
    shinzui: "Shinzui Facewash Woman",
    garnier: "Garnier Facewash Woman",
    scora: "Scora Facewash Woman",
    you: "You Facewash Woman"
  };

  for (const brand in brandMappings) {
    if (lowerName.includes(brand)) {
      return imageMap[brandMappings[brand]];
    }
  }

  return '';
}

// ================= PROSES PRODUK =================
const maxProducts = Math.min(products.length, 12);
const processedProducts = [];

for (let i = 0; i < maxProducts; i++) {
  const p = products[i];
  if (!p || typeof p !== 'object') continue;

  const namaProduk = p.nama || p.name || '';
  const harga = p.harga || p.price || '';
  const alasan = p.alasan || p.benefit || '';
  const searchQuery = p.search_query || p.search || namaProduk;

  processedProducts.push({
    json: {
      nama: namaProduk,
      harga: harga,
      alasan: alasan,
      image: findMatchingImage(namaProduk),
      url: 'https://shopee.co.id/search?keyword=' + encodeURIComponent(searchQuery)
    }
  });
}

// ================= FALLBACK =================
if (processedProducts.length === 0) {
  return [{
    json: {
      error: "Tidak ada produk valid yang diproses",
      original_count: products.length
    }
  }];
}

return processedProducts;