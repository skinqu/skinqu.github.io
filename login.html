<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Masuk</title>
  <link rel="stylesheet" href="/assets/css/login.css" />
  <!-- Opsional: Google Fonts (Poppins populer untuk UI modern) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="logo">
        <!--<div class="logo-icon">üíß</div>-->
        <!--<h1 class="logo-text">SkinCare.id</h1>-->
      </div>

      <h2 class="card-title">Masuk ke Akun Anda</h2>
      <p class="subtitle">Selamat datang kembali! Silakan masuk untuk melanjutkan.</p>

      <form id="loginForm" novalidate>
        <div class="form-group">
          <label for="email">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            autocomplete="email"
            required
            placeholder="contoh@email.com"
          />
        </div>

        <div class="form-group">
          <div class="label-row">
            <label for="password">Kata Sandi</label>
            <a href="#" class="forgot-link">Lupa kata sandi?</a>
          </div>
          <div class="password-wrapper">
            <input
              type="password"
              id="password"
              name="password"
              autocomplete="current-password"
              required
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
            <button type="button" class="toggle-password" aria-label="Tampilkan kata sandi">
              üëÅÔ∏è
            </button>
          </div>
        </div>

        <button type="submit" class="btn-primary">Masuk</button>
      </form>

      <!--<div class="divider">
        <span>atau</span>
      </div>-->

      <!--<div class="social-login">
        <button class="btn-social btn-google">
          <span>Google</span>
        </button>
        <button class="btn-social btn-facebook">
          <span>Facebook</span>
        </button>
      </div>-->

      <div class="signup-prompt">
        Belum punya akun? <a href="/register.html" class="signup-link">Daftar sekarang</a>
      </div>
    </div>

    <div class="footer-note">
      ¬© 2025 Skinqu ‚Ä¢ Privasi & Ketentuan
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================
// SUPABASE INIT - PAKAI NAMA UNIK
// ============================================
const supabaseAuth = supabase.createClient(
  "https://bnawrgrhmvkyzkixlbkc.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuYXdyZ3JobXZreXpraXhsYmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NDA2MDUsImV4cCI6MjA4MTIxNjYwNX0.msUs2RMnJqAs086mkV4FTNIEOHb_3i-hGX5B0sWtolg"
);

// ============================================
// ELEMENTS
// ============================================
const submitBtn = document.querySelector('.btn-primary');
const loginForm = document.getElementById('loginForm');

// ============================================
// TOGGLE PASSWORD VISIBILITY
// ============================================
document.querySelectorAll('.toggle-password').forEach(btn => {
  btn.addEventListener('click', function() {
    const input = this.previousElementSibling;
    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
    input.setAttribute('type', type);
    this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
  });
});

// ============================================
// CHECK URL PARAMS FOR REGISTRATION SUCCESS
// ============================================
function checkURLParams() {
  const urlParams = new URLSearchParams(window.location.search);
  
  if (urlParams.get('registered') === 'true') {
    const email = urlParams.get('email');
    const message = email 
      ? `üéâ Registrasi berhasil! Akun dengan email ${decodeURIComponent(email)} telah dibuat. Silakan masuk.`
      : 'üéâ Registrasi berhasil! Silakan masuk dengan akun Anda.';
    
    // Tampilkan toast notification
    showToast(message, 'success');
    
    // Clear URL params tanpa reload
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  
  if (urlParams.get('verified') === 'true') {
    showToast('‚úÖ Email Anda telah berhasil diverifikasi! Silakan masuk.', 'success');
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}

// ============================================
// SHOW TOAST NOTIFICATION
// ============================================
function showToast(message, type = 'info') {
  // Hapus toast sebelumnya jika ada
  const existingToast = document.querySelector('.toast-notification');
  if (existingToast) existingToast.remove();
  
  const toast = document.createElement('div');
  toast.className = `toast-notification toast-${type}`;
  toast.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 20px;">${type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}</span>
      <div>${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Animasi masuk
  setTimeout(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateY(0)';
  }, 10);
  
  // Auto remove setelah 5 detik
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-20px)';
    setTimeout(() => {
      if (toast.parentNode) toast.parentNode.removeChild(toast);
    }, 300);
  }, 5000);
}

// ============================================
// LOGIN FORM SUBMISSION
// ============================================
loginForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const email = this.email.value.trim();
  const password = this.password.value;
  
  // VALIDATION
  if (!email || !password) {
    showToast('Harap isi email dan kata sandi.', 'error');
    return;
  }
  
  if (!validateEmail(email)) {
    showToast('Format email tidak valid.', 'error');
    return;
  }
  
  if (password.length < 8) {
    showToast('Password minimal 8 karakter.', 'error');
    return;
  }
  
  // LOADING STATE
  const originalText = submitBtn.textContent;
  submitBtn.innerHTML = '<span class="spinner"></span>Memproses...';
  submitBtn.disabled = true;
  
  try {
    console.log("=== LOGIN ATTEMPT ===");
    console.log("Email:", email);
    
    // 1. ATTEMPT LOGIN
    const { data: authData, error: authError } = await supabaseAuth.auth.signInWithPassword({
      email,
      password
    });
    
    if (authError) {
      console.error("Login Error:", authError);
      
      // Check specific error types
      if (authError.message.includes('Invalid login credentials')) {
        throw new Error('Email atau password salah.');
      } else if (authError.message.includes('Email not confirmed')) {
        throw new Error('Email belum diverifikasi. Silakan cek inbox email Anda.');
      } else if (authError.message.includes('rate limit')) {
        throw new Error('Terlalu banyak percobaan login. Silakan coba lagi nanti.');
      } else {
        throw new Error(authError.message);
      }
    }
    
    console.log("‚úÖ Login successful!");
    console.log("User:", authData.user);
    
    // 2. GET USER PROFILE
    const userId = authData.user.id;
    const { data: profileData, error: profileError } = await supabaseAuth
      .from('profiles')
      .select('nama')
      .eq('id', userId)
      .single();
    
    if (profileError) {
      console.warn("Profile fetch warning:", profileError.message);
    } else {
      console.log("User profile:", profileData);
      
      // Save user info to localStorage/session
      localStorage.setItem('user_name', profileData.nama || email.split('@')[0]);
      localStorage.setItem('user_email', email);
    }
    
    // 3. REDIRECT TO DASHBOARD/HOME
    showToast('Login berhasil! Mengalihkan...', 'success');
    
    setTimeout(() => {
      window.location.href = 'index.html'; // Ganti dengan halaman tujuan
    }, 1500);
    
  } catch (error) {
    console.error("üí• LOGIN ERROR:", error);
    
    // RESET BUTTON
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
    
    // SHOW ERROR TO USER
    showToast(`‚ùå ${error.message}`, 'error');
  }
});

// ============================================
// FORGOT PASSWORD HANDLER
// ============================================
document.querySelector('.forgot-link')?.addEventListener('click', async function(e) {
  e.preventDefault();
  
  const email = prompt('Masukkan email Anda untuk reset password:');
  if (!email) return;
  
  if (!validateEmail(email)) {
    showToast('Format email tidak valid.', 'error');
    return;
  }
  
  try {
    const { error } = await supabaseAuth.auth.resetPasswordForEmail(email, {
      redirectTo: `${window.location.origin}/reset-password.html`
    });
    
    if (error) {
      throw error;
    }
    
    showToast(`‚úÖ Link reset password telah dikirim ke ${email}. Silakan cek inbox Anda.`, 'success');
  } catch (error) {
    console.error("Reset password error:", error);
    showToast(`‚ùå Gagal mengirim email reset: ${error.message}`, 'error');
  }
});

// ============================================
// UTILITY FUNCTIONS
// ============================================
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

// ============================================
// AUTO FILL FROM URL PARAMS
// ============================================
function autoFillFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const email = urlParams.get('email');
  
  if (email && document.getElementById('email')) {
    document.getElementById('email').value = decodeURIComponent(email);
  }
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  console.log("üìÑ Login page loaded");
  
  // Check for success messages from registration
  checkURLParams();
  
  // Auto fill email from URL
  autoFillFromURL();
  
  // Add spinner CSS
  if (!document.querySelector('#spinner-style')) {
    const style = document.createElement('style');
    style.id = 'spinner-style';
    style.textContent = `
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        color: #333;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 400px;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        border-left: 4px solid #4361ee;
      }
      
      .toast-success {
        border-left-color: #4CAF50;
      }
      
      .toast-error {
        border-left-color: #f44336;
      }
    `;
    document.head.appendChild(style);
  }
});

// ============================================
// SOCIAL LOGIN PLACEHOLDER
// ============================================
document.querySelectorAll('.btn-social').forEach(btn => {
  btn.addEventListener('click', function() {
    const provider = this.classList.contains('btn-google') ? 'Google' : 'Facebook';
    showToast(`‚ö†Ô∏è Login dengan ${provider} sedang dalam pengembangan.`, 'info');
  });
});
</script>
</body>
</html>