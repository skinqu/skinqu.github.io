<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Produk Rekomendasi – SkinQu</title>

<link rel="stylesheet" href="assets/css/cssproduct.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.product-card {
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  text-align: left;
}

.price-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 6px 0;
}

.favorite-btn {
  font-size: 26px;
  cursor: pointer;
  transition: all 0.25s ease;
  color: #cfcfcf;
  display: flex;
  align-items: center;
  justify-content: center;
}

.favorite-btn.active {
  color: #ff2d55;
  text-shadow: 0 0 6px rgba(255, 45, 85, 0.6);
  transform: scale(1.25);
}

.favorite-btn:hover {
  transform: scale(1.15);
}
</style>
</head>

<body>

<div class="topbar">
  <span>Produk Rekomendasi</span>
</div>

<div class="product-grid" id="productGrid"></div>

<div class="bottom-nav">
  <div class="nav-item"><a href="index.html"><img src="assets/img/home.png"></a></div>
  <div class="nav-item"><a href="scanwajah.html"><img src="assets/img/scanwajah.png"></a></div>
  <div class="nav-item"><a href="favorite.html"><img src="assets/img/heart.png"></a></div>
  <div class="nav-item"><a href="profile.html"><img src="assets/img/user.png"></a></div>
</div>

<script>
/* ================= SUPABASE INIT ================= */
const SUPABASE_URL = "https://bnawrgrhmvkyzkixlbkc.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuYXdyZ3JobXZreXpraXhsYmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NDA2MDUsImV4cCI6MjA4MTIxNjYwNX0.msUs2RMnJqAs086mkV4FTNIEOHb_3i-hGX5B0sWtolg";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let USER_ID = null;
const MAX = 6;

const grid = document.getElementById("productGrid");

/* ================= GET USER ================= */
async function getUser() {
  const { data: { user } } = await supabase.auth.getUser();
  if (user) {
    USER_ID = user.id;
  }
}

/* ================= CHECK FAVORITE ================= */
async function isFavorite(productName) {
  if (!USER_ID) return false;

  const { data } = await supabase
    .from("favorites")
    .select("id")
    .eq("user_id", USER_ID)
    .eq("product->>nama", productName);

  return data.length > 0;
}

/* ================= TOGGLE FAVORITE ================= */
async function toggleFavorite(el, product) {
  if (!USER_ID) {
    alert("Silakan login terlebih dahulu ❤️");
    window.location.href = "login.html";
    return;
  }

  const isFav = await isFavorite(product.nama);

  if (isFav) {
    await supabase
      .from("favorites")
      .delete()
      .eq("user_id", USER_ID)
      .eq("product->>nama", product.nama);

    el.classList.remove("active");
  } else {
    await supabase
      .from("favorites")
      .insert({
        user_id: USER_ID,
        product: product
      });

    el.classList.add("active");
  }
}

/* ================= LOAD PRODUCT ================= */
async function loadProducts() {
  const { data } = await supabase
    .from("rekomendasi_produk")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(MAX);

  grid.innerHTML = "";

  for (const p of data) {
    const fav = USER_ID ? await isFavorite(p.nama) : false;

    grid.innerHTML += `
      <div class="product-card">
        <img src="${p.image}" />
        <div class="product-name">${p.nama}</div>

        <div class="price-row">
          <div class="product-price">${p.harga}</div>
          <div class="favorite-btn ${fav ? 'active' : ''}"
               onclick='toggleFavorite(this, ${JSON.stringify(p)})'>
            ♥
          </div>
        </div>

        <button class="buy-btn"
          onclick="window.open('https://shopee.co.id/search?keyword=${encodeURIComponent(p.nama)}')">
          Pesan Produk
        </button>
      </div>
    `;
  }
}

/* ================= INIT ================= */
(async () => {
  await getUser();
  await loadProducts();
})();
</script>

</body>
</html>
