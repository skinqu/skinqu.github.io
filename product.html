<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Produk Rekomendasi – SkinQu</title>
<script src="assets/js/bottom-nav.js" defer></script>
<link rel="stylesheet" href="assets/css/cssindex.css">
<link rel="stylesheet" href="assets/css/cssproduct.css">

<style>
.product-card {
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  text-align: left;
}

.price-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 6px 0;
}

.favorite-btn {
  font-size: 26px;
  cursor: pointer;
  transition: all 0.25s ease;
  color: #cfcfcf;
  display: flex;
  align-items: center;
  justify-content: center;
}

.favorite-btn.active {
  color: #ff2d55;
  text-shadow: 0 0 6px rgba(255, 45, 85, 0.6);
  transform: scale(1.25);
}

.favorite-btn:hover {
  transform: scale(1.15);
}
</style>
</head>

<body>

<div class="topbar">
  <span>Produk Rekomendasi</span>
</div>

<div class="product-grid" id="productGrid"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* ================= CONFIG ================= */
const SUPABASE_URL = "https://bnawrgrhmvkyzkixlbkc.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuYXdyZ3JobXZreXpraXhsYmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NDA2MDUsImV4cCI6MjA4MTIxNjYwNX0.msUs2RMnJqAs086mkV4FTNIEOHb_3i-hGX5B0sWtolg";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
const grid = document.getElementById("productGrid");
const MAX =6;

let USER_ID = null;
let ACCESS_TOKEN = null;

/* ================= INIT SESSION ================= */
async function initSession() {
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    window.location.href = "login.html";
    return;
  }

  USER_ID = session.user.id;
  ACCESS_TOKEN = session.access_token;

  loadProducts();
}

/* ================= CHECK FAVORITE ================= */
window.isFavorite = async function (productName) {
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/favorites?select=id&user_id=eq.${USER_ID}&product->>nama=eq.${encodeURIComponent(productName)}`,
    {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: "Bearer " + ACCESS_TOKEN
      }
    }
  );

  const data = await res.json();
  return data.length > 0;
};

/* ================= TOGGLE FAVORITE ================= */
window.toggleFavorite = async function (el, product) {
  const fav = await isFavorite(product.nama);

  if (fav) {
    // DELETE
    await fetch(
      `${SUPABASE_URL}/rest/v1/favorites?user_id=eq.${USER_ID}&product->>nama=eq.${encodeURIComponent(product.nama)}`,
      {
        method: "DELETE",
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: "Bearer " + ACCESS_TOKEN
        }
      }
    );
    el.classList.remove("active");
  } else {
    // INSERT
    await fetch(`${SUPABASE_URL}/rest/v1/favorites`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: "Bearer " + ACCESS_TOKEN,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: USER_ID,
        product: product
      })
    });
    el.classList.add("active");
  }
};

/* ================= LOAD PRODUCTS ================= */
async function loadProducts() {
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/rekomendasi_produk?select=*&order=created_at.desc&limit=${MAX}`,
    {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: "Bearer " + ACCESS_TOKEN
      }
    }
  );

  const data = await res.json();
  grid.innerHTML = "";

  for (const p of data) {
    const fav = await isFavorite(p.nama);

    grid.innerHTML += `
      <div class="product-card">
        <img src="${p.image}" />
        <div class="product-name">${p.nama}</div>

        <div class="price-row">
          <div class="product-price">${p.harga}</div>
          <div class="favorite-btn ${fav ? "active" : ""}"
               onclick='toggleFavorite(this, ${JSON.stringify(p)})'>
            ♥
          </div>
        </div>

        <button class="buy-btn"
          onclick="window.open('https://shopee.co.id/search?keyword=${encodeURIComponent(p.nama)}')">
          Pesan Produk
        </button>
      </div>
    `;
  }
}

/* ================= START ================= */
initSession();
</script>

</body>
</html>
