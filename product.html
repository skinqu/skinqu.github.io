<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* ================= CONFIG ================= */
const SUPABASE_URL = "https://bnawrgrhmvkyzkixlbkc.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuYXdyZ3JobXZreXpraXhsYmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NDA2MDUsImV4cCI6MjA4MTIxNjYwNX0.msUs2RMnJqAs086mkV4FTNIEOHb_3i-hGX5B0sWtolg";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
const grid = document.getElementById("productGrid");
const MAX = 6;

let USER_ID = null;

/* ================= INIT SESSION ================= */
async function initSession() {
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    window.location.href = "login.html";
    return;
  }

  USER_ID = session.user.id;
  loadProducts();
}

/* ================= CHECK FAVORITE ================= */
window.isFavorite = async function (productName) {
  try {
    // Cek di tabel profiles - asumsi ada kolom favorites yang bertipe JSON atau JSONB
    const { data, error } = await supabase
      .from('profiles')
      .select('favorites')
      .eq('user_id', USER_ID)
      .single();

    if (error) {
      console.error("Error checking favorite:", error);
      return false;
    }

    // Jika favorites ada dan merupakan array, cek apakah produk ada di dalamnya
    if (data && data.favorites && Array.isArray(data.favorites)) {
      return data.favorites.some(fav => fav.product && fav.product.nama === productName);
    }
    
    return false;
  } catch (err) {
    console.error("Error in isFavorite:", err);
    return false;
  }
};

/* ================= TOGGLE FAVORITE ================= */
window.toggleFavorite = async function (el, product) {
  try {
    const isFav = await isFavorite(product.nama);
    
    // Ambil data favorites saat ini
    const { data: currentData, error: fetchError } = await supabase
      .from('profiles')
      .select('favorites')
      .eq('user_id', USER_ID)
      .single();

    if (fetchError) {
      console.error("Error fetching current favorites:", fetchError);
      return;
    }

    let currentFavorites = currentData?.favorites || [];
    
    // Pastikan currentFavorites adalah array
    if (!Array.isArray(currentFavorites)) {
      currentFavorites = [];
    }

    if (isFav) {
      // Hapus dari favorites
      const updatedFavorites = currentFavorites.filter(
        fav => !(fav.product && fav.product.nama === product.nama)
      );
      
      const { error } = await supabase
        .from('profiles')
        .update({ 
          favorites: updatedFavorites,
          updated_at: new Date().toISOString()
        })
        .eq('user_id', USER_ID);

      if (error) {
        console.error("Error removing favorite:", error);
        return;
      }
      
      el.classList.remove("active");
      console.log("Product removed from favorites");
    } else {
      // Tambah ke favorites
      const newFavorite = {
        user_id: USER_ID,
        product: {
          nama: product.nama,
          harga: product.harga,
          image: product.image
        },
        created_at: new Date().toISOString()
      };

      const updatedFavorites = [...currentFavorites, newFavorite];
      
      const { error } = await supabase
        .from('profiles')
        .update({ 
          favorites: updatedFavorites,
          updated_at: new Date().toISOString()
        })
        .eq('user_id', USER_ID);

      if (error) {
        // Jika update gagal, mungkin record belum ada, coba insert
        const { error: insertError } = await supabase
          .from('profiles')
          .insert({
            user_id: USER_ID,
            favorites: [newFavorite],
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          });

        if (insertError) {
          console.error("Error adding favorite:", insertError);
          return;
        }
      }
      
      el.classList.add("active");
      console.log("Product added to favorites");
    }
  } catch (err) {
    console.error("Error in toggleFavorite:", err);
  }
};

/* ================= LOAD PRODUCTS ================= */
async function loadProducts() {
  try {
    const { data, error } = await supabase
      .from('rekomendasi_produk')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(MAX);

    if (error) {
      console.error("Error loading products:", error);
      return;
    }

    grid.innerHTML = "";

    for (const p of data) {
      const fav = await isFavorite(p.nama);

      const productCard = document.createElement('div');
      productCard.className = 'product-card';
      
      productCard.innerHTML = `
        <img src="${p.image}" alt="${p.nama}" />
        <div class="product-name">${p.nama}</div>
        <div class="price-row">
          <div class="product-price">${p.harga}</div>
          <div class="favorite-btn ${fav ? 'active' : ''}"
               onclick='toggleFavorite(this, ${JSON.stringify(p).replace(/'/g, "&#39;")})'>
            â™¥
          </div>
        </div>
        <button class="buy-btn"
          onclick="window.open('https://shopee.co.id/search?keyword=${encodeURIComponent(p.nama)}')">
          Pesan Produk
        </button>
      `;
      
      grid.appendChild(productCard);
    }
  } catch (err) {
    console.error("Error in loadProducts:", err);
  }
}

/* ================= START ================= */
initSession();
</script>