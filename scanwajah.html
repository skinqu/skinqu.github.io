<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>SkinQu ‚Ä¢ AI Facial Scan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-glow: rgba(37, 99, 235, 0.4);
      --scan-line: #3b82f6;
      --glass-bg: rgba(15, 23, 42, 0.65);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text: #f1f5f9;
      --text-sub: #94a3b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      background: linear-gradient(160deg, #0b0e1a, #111827, #0d1117);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 28px 16px 32px;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, transparent 40%, rgba(11, 14, 26, 0.9) 90%);
      z-index: -1;
      pointer-events: none;
    }

    .header {
      text-align: center;
      margin-bottom: 28px;
      max-width: 360px;
    }

    .header h1 {
      font-weight: 700;
      font-size: 28px;
      letter-spacing: -0.5px;
      background: linear-gradient(100deg, #e2e8f0, #cbd5e1);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 6px;
    }

    .header p {
      font-size: 15px;
      color: var(--text-sub);
      line-height: 1.5;
    }

    .camera-frame {
      position: relative;
      width: 100%;
      max-width: 380px;
      aspect-ratio: 4/5;
      margin: 0 auto 28px;
      border-radius: 28px;
      overflow: hidden;
      background: #000;
      box-shadow:
        0 12px 30px rgba(0, 0, 0, 0.5),
        inset 0 0 0 1px var(--glass-border);
      isolation: isolate;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
      transform: scaleX(-1);
    }

    /* Glass overlay */
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 2;
    }

    .face-outline {
      width: 65%;
      max-width: 220px;
      filter: drop-shadow(0 0 8px var(--primary-glow));
    }

    .face-outline path {
      fill: none;
      stroke: var(--primary);
      stroke-width: 1.5;
      stroke-dasharray: 6, 4;
      stroke-linecap: round;
      opacity: 0.9;
      animation: pulse 3s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { stroke-dashoffset: 0; opacity: 0.7; }
      50% { stroke-dashoffset: -10; opacity: 0.95; }
    }

    .guide-text {
      position: absolute;
      top: 24%;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      background: rgba(0, 0, 0, 0.25);
      padding: 4px 12px;
      border-radius: 20px;
      backdrop-filter: blur(6px);
      margin-top: -40px;
    }

    /* Scan line animation */
    .scan-line {
      position: absolute;
      top: -10px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--scan-line), transparent);
      box-shadow: 0 0 12px var(--primary-glow);
      opacity: 0;
      transform: scaleX(0.95);
      z-index: 3;
    }

    /* Flash effect */
    .flash {
      position: absolute;
      inset: 0;
      background: white;
      opacity: 0;
      z-index: 4;
      pointer-events: none;
    }

    #permission-msg {
      color: #94a3b8;
      font-size: 16px;
      text-align: center;
      padding: 32px;
      line-height: 1.5;
    }

    .btn {
      width: 100%;
      max-width: 380px;
      padding: 18px;
      font-size: 17px;
      font-weight: 600;
      border: none;
      border-radius: 20px;
      background: linear-gradient(135deg, #447DCE, #447DCE);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow:
        0 4px 16px rgba(30, 64, 175, 0.3),
        0 0 0 2px rgba(59, 130, 246, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow:
        0 6px 20px rgba(30, 64, 175, 0.45),
        0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      transform: none;
      cursor: not-allowed;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Loading overlay baru */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(11, 14, 26, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 24px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .loading-subtext {
      color: var(--text-sub);
      font-size: 14px;
      max-width: 280px;
      text-align: center;
      line-height: 1.5;
    }

    .status-steps {
      margin-top: 30px;
      width: 100%;
      max-width: 300px;
    }

    .step {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      opacity: 0.5;
      transition: opacity 0.3s ease;
    }

    .step.active {
      opacity: 1;
    }

    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 12px;
    }

    .step.active .step-icon {
      background: var(--primary);
    }

    .step-text {
      font-size: 14px;
      color: var(--text-sub);
    }

    .step.active .step-text {
      color: var(--text);
      font-weight: 500;
    }

    .loading-state {
      display: none;
      text-align: center;
      margin-top: 16px;
      font-size: 15px;
      color: var(--text-sub);
    }

    .particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.4);
      animation: float 15s infinite linear;
    }

    @keyframes float {
      to { transform: translateY(-100vh) translateX(100px); opacity: 0; }
    }

    .note {
      font-size: 11px;
      color: #64748b;
      margin-top: 24px;
      max-width: 380px;
      line-height: 1.5;
    }

    @media (max-width: 375px) {
      .header h1 { font-size: 26px; }
      .camera-frame { border-radius: 24px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>SkinQu AI Scanner</h1>
    <p>Lakukan pemindaian wajah real-time untuk rekomendasi perawatan kulit personal.</p>
  </div>

  <div class="camera-frame">
    <div id="permission-msg">üîç Mengaktifkan kamera‚Ä¶</div>
    <video id="video" playsinline muted></video>
    
    <div class="overlay">
      <div class="guide-text">Letakkan wajah di dalam garis</div>
      <svg class="face-outline" viewBox="0 0 100 130" xmlns="http://www.w3.org/2000/svg">
        <path d="M50,15 
                 C30,15 18,28 18,46 
                 C18,58 24,70 34,82 
                 C30,88 28,96 28,104 
                 C28,112 32,118 38,122 
                 C44,126 56,126 62,122 
                 C68,118 72,112 72,104 
                 C72,96 70,88 66,82 
                 C76,70 82,58 82,46 
                 C82,28 70,15 50,15 Z
                 
                 M38,48 
                 C38,48 42,44 50,44 
                 C58,44 62,48 62,48 
                 
                 M44,90 
                 Q50,96 56,90" />
      </svg>
    </div>

    <div class="scan-line" id="scanLine"></div>
    <div class="flash" id="flash"></div>
    <div class="particles" id="particles"></div>
  </div>

  <button id="scanBtn" class="btn" disabled>
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="3"></circle>
      <path d="M12 3v2"></path>
      <path d="M12 19v2"></path>
      <path d="M5 12h2"></path>
      <path d="M17 12h2"></path>
      <path d="M7 7l1.5 1.5"></path>
      <path d="M15.5 15.5L17 17"></path>
      <path d="M17 7l-1.5 1.5"></path>
      <path d="M8.5 15.5L7 17"></path>
    </svg>
    Mulai Pemindaian
  </button>

  <!-- Loading overlay baru -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Memproses analisis wajah</div>
    <div class="loading-subtext">AI kami sedang menganalisis kulit dan mencari produk terbaik untuk Anda</div>
    
    <div class="status-steps">
      <div class="step active" id="step1">
        <div class="step-icon">1</div>
        <div class="step-text">Mengambil gambar wajah</div>
      </div>
      <div class="step" id="step2">
        <div class="step-icon">2</div>
        <div class="step-text">Mengirim ke server AI</div>
      </div>
      <div class="step" id="step3">
        <div class="step-icon">3</div>
        <div class="step-text">Analisis karakteristik kulit</div>
      </div>
      <div class="step" id="step4">
        <div class="step-icon">4</div>
        <div class="step-text">Menyiapkan rekomendasi</div>
      </div>
    </div>
  </div>

  <div class="loading-state" id="loading">
    Memproses hasil scan AI‚Ä¶
  </div>

  <div class="note">
    üîí Data tidak disimpan. Analisis dilakukan lokal & cloud aman. Bukan diagnosis medis.
  </div>

  <canvas id="canvas" hidden></canvas>

  <script>
  const N8N_WEBHOOK = "https://aang34.app.n8n.cloud/webhook/scan-wajah";
  
  // ====================== CONFIGURASI WAKTU PROSES ======================
  const PROCESSING_CONFIG = {
    INITIAL_WAIT: 3000,      // Tunggu 3 detik setelah scan sebelum mulai polling
    POLLING_INTERVAL: 2000,  // Poll setiap 2 detik
    MAX_POLLING_TIME: 45000,  // Maksimal 45 detik polling
    PROGRESS_UPDATE: 500     // Update progress setiap 500ms
  };
  // =====================================================================

  const video = document.getElementById('video');
  const scanBtn = document.getElementById('scanBtn');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const permissionMsg = document.getElementById('permission-msg');
  const scanLine = document.getElementById('scanLine');
  const flashEl = document.getElementById('flash');
  const particlesContainer = document.getElementById('particles');

  // Variabel untuk mengelola status loading
  let isProcessing = false;
  let progressInterval;
  let elapsedSeconds = 0;

  // ‚ú® Generate floating particles
  function createParticles() {
    for (let i = 0; i < 12; i++) {
      const p = document.createElement('div');
      p.classList.add('particle');
      p.style.left = `${Math.random() * 100}%`;
      p.style.top = `${100 + Math.random() * 20}%`;
      p.style.animationDuration = `${10 + Math.random() * 20}s`;
      p.style.opacity = Math.random() * 0.5 + 0.2;
      p.style.width = `${2 + Math.random() * 3}px`;
      p.style.height = p.style.width;
      particlesContainer.appendChild(p);
    }
  }

  // üì∏ Init camera
  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'user',
          width: { ideal: 720 },
          height: { ideal: 960 }
        },
        audio: false
      });

      video.srcObject = stream;
      video.style.display = 'block';
      permissionMsg.style.display = 'none';

      video.onloadedmetadata = () => video.play();
      scanBtn.disabled = false;

      createParticles();
    } catch (err) {
      console.error("Camera error:", err);
      permissionMsg.innerHTML = `‚ö†Ô∏è Akses kamera dibutuhkan.<br><small>Buka pengaturan ‚Üí izinkan kamera ‚Üí refresh.</small>`;
    }
  }

  // üåÄ Efek scan (garis + flash)
  function runScanAnimation() {
    return new Promise(resolve => {
      scanLine.style.opacity = '0';
      scanLine.style.top = '-10px';

      setTimeout(() => {
        scanLine.style.transition = 'top 1.8s ease-out, opacity 0.3s';
        scanLine.style.opacity = '1';
        scanLine.style.top = '100%';
      }, 100);

      setTimeout(() => {
        flashEl.style.transition = 'opacity 0.4s';
        flashEl.style.opacity = '0.8';
        setTimeout(() => {
          flashEl.style.opacity = '0';
          resolve();
        }, 200);
      }, 1700);
    });
  }

  // üîÑ Update status loading steps dengan timer
  function updateLoadingStep(stepNumber, description = '') {
    // Reset semua step
    for (let i = 1; i <= 4; i++) {
      const step = document.getElementById(`step${i}`);
      step.classList.remove('active');
    }
    
    // Aktifkan step yang diminta
    for (let i = 1; i <= stepNumber; i++) {
      const step = document.getElementById(`step${i}`);
      step.classList.add('active');
    }
    
    // Update description jika ada
    if (description && stepNumber <= 4) {
      const stepText = document.querySelector(`#step${stepNumber} .step-text`);
      if (stepText) {
        stepText.innerHTML = description;
      }
    }
  }

  // ‚è±Ô∏è Update progress timer di UI
  function updateProgressTimer() {
    elapsedSeconds++;
    const timerText = document.querySelector('.loading-subtext');
    if (timerText) {
      timerText.textContent = `Proses AI membutuhkan waktu 9-15 detik. Sedang diproses: ${elapsedSeconds} detik...`;
    }
    
    // Update progress bar jika ada
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
      const progressPercent = Math.min((elapsedSeconds / 15) * 100, 100);
      progressBar.style.width = `${progressPercent}%`;
    }
  }

  // üîç Polling untuk mengecek status proses AI di n8n
  async function pollProcessingStatus(sessionId) {
    const startTime = Date.now();
    
    while (Date.now() - startTime < PROCESSING_CONFIG.MAX_POLLING_TIME) {
      try {
        console.log(`Polling status untuk session: ${sessionId}`);
        
        // Kirim request ke endpoint status n8n (anda perlu buat endpoint ini di n8n)
        const statusRes = await fetch(`${N8N_WEBHOOK}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId })
        });
        
        if (statusRes.ok) {
          const statusData = await statusRes.json();
          
          // ====================== LOGIKA STATUS N8N ======================
          // Anda perlu sesuaikan dengan respons n8n:
          // status: "processing", "completed", "failed"
          // products: (array jika completed)
          // ==============================================================
          
          if (statusData.status === 'completed') {
            return {
              success: true,
              products: statusData.products,
              message: 'Proses AI selesai'
            };
          } else if (statusData.status === 'failed') {
            return {
              success: false,
              error: statusData.error || 'Proses AI gagal'
            };
          }
          // Jika masih processing, lanjut polling
        }
      } catch (error) {
        console.warn('Polling error:', error);
      }
      
      // Tunggu sebelum polling berikutnya
      await new Promise(resolve => setTimeout(resolve, PROCESSING_CONFIG.POLLING_INTERVAL));
    }
    
    return {
      success: false,
      error: 'Waktu proses AI terlalu lama (timeout)'
    };
  }

  // üì§ Scan & kirim - VERSI POLLING UNTUK PROSES AI 9-15 DETIK
  // üì§ Scan & kirim - VERSI DIPERBAIKI dengan FALLBACK
async function scanWajah() {
  if (isProcessing) return;
  
  if (!video.srcObject) {
    alert("Kamera belum siap. Tunggu sebentar...");
    return;
  }

  // Nonaktifkan tombol scan
  scanBtn.disabled = true;
  isProcessing = true;
  elapsedSeconds = 0;
  
  // Tampilkan loading overlay
  loadingOverlay.style.display = "flex";
  updateLoadingStep(1, "Mengambil gambar wajah...");

  try {
    // 1. Jalankan animasi scan
    await runScanAnimation();
    
    // Tunggu sebentar untuk efek visual
    await new Promise(r => setTimeout(r, 300));

    // 2. Ambil gambar dari video
    updateLoadingStep(2, "Menyimpan gambar untuk analisis...");
    
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const size = Math.min(video.videoWidth, video.videoHeight);
    const x = (video.videoWidth - size) / 2;
    const y = (video.videoHeight - size) / 2;

    canvas.width = 512;
    canvas.height = 512;
    ctx.drawImage(video, x, y, size, size, 0, 0, 512, 512);
    const imageBase64 = canvas.toDataURL('image/jpeg', 0.72);

    // 3. Mulai progress timer
    progressInterval = setInterval(updateProgressTimer, PROCESSING_CONFIG.PROGRESS_UPDATE);

    // 4. Buat session ID unik untuk tracking
    const sessionId = `scan_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // 5. Kirim ke n8n UNTUK MEMULAI PROSES
    updateLoadingStep(3, "Mengirim ke server AI...");
    
    const requestData = {
      session_id: sessionId,
      umur: "25",
      gender: "netral",
      hamil: "tidak",
      category: "toner",
      berminyak: "tidak",
      kering: "tidak",
      kusam: "tidak",
      berjerawat: "tidak",
      sensitif: "tidak",
      beruntusan: "tidak",
      flek: "tidak",
      kemerahan: "tidak",
      pori: "tidak",
      komedo: "tidak",
      image: imageBase64
    };

    console.log("üì§ Mengirim data ke n8n...", { 
      sessionId, 
      imageSize: imageBase64.length,
      timestamp: new Date().toISOString() 
    });

    // ====================== STRATEGI 1: KIRIM DAN TUNGGU LANGSUNG ======================
    let n8nResponse;
    let n8nError = null;
    
    try {
      // Kirim request ke n8n dengan timeout 25 detik
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 25000);
      
      const initiateRes = await fetch(N8N_WEBHOOK, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(requestData),
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!initiateRes.ok) {
        throw new Error(`HTTP ${initiateRes.status}: ${await initiateRes.text()}`);
      }
      
      n8nResponse = await initiateRes.json();
      console.log("‚úÖ Respons n8n diterima:", n8nResponse);
      
    } catch (fetchError) {
      n8nError = fetchError;
      console.warn("‚ö†Ô∏è Gagal mendapatkan respons langsung dari n8n:", fetchError);
      
      // JANGAN throw error di sini, lanjut ke fallback
      updateLoadingStep(3, "Menghubungkan ke server AI...");
    }

    // ====================== STRATEGI 2: FALLBACK KE SIMULASI AI ======================
    // Jika n8n gagal merespons dalam 25 detik, gunakan data simulasi
    updateLoadingStep(4, "Menganalisis karakteristik kulit...");
    
    // Simulasi proses AI selama 5-8 detik
    const aiProcessTime = 5000 + Math.random() * 3000;
    await new Promise(r => setTimeout(r, aiProcessTime));
    
    updateLoadingStep(4, "Menyiapkan rekomendasi...");
    
    // ====================== DATA FALLBACK JIKA n8n ERROR ======================
    let finalProducts;
    
    if (n8nResponse && n8nResponse.products) {
      // Gunakan data dari n8n jika ada
      finalProducts = n8nResponse.products;
      console.log("‚úÖ Menggunakan data real dari n8n");
    } else {
      // FALLBACK: Data simulasi berdasarkan kategori
      console.log("‚ö†Ô∏è Menggunakan data fallback (n8n timeout/error)");
      
      // Data fallback berdasarkan kategori yang dipilih
      const fallbackProducts = {
        "toner": [
          {
            nama: "Toner Brightening Serum",
            harga: "Rp 189.000",
            brand: "SkinQu Expert",
            deskripsi: "Toner mencerahkan dengan niacinamide 5%",
            rating: 4.8,
            image: "https://via.placeholder.com/300x200/2563eb/ffffff?text=Toner+AI"
          },
          {
            nama: "Hydrating Toner Essence",
            harga: "Rp 245.000",
            brand: "HydraGlow",
            deskripsi: "Toner hidrasi intensif dengan hyaluronic acid",
            rating: 4.7,
            image: "https://via.placeholder.com/300x200/10b981/ffffff?text=Hydrating+Toner"
          },
          {
            nama: "Acne Care Toner",
            harga: "Rp 167.500",
            brand: "ClearSkin",
            deskripsi: "Toner untuk kulit berjerawat dengan salicylic acid",
            rating: 4.6,
            image: "https://via.placeholder.com/300x200/ef4444/ffffff?text=Acne+Toner"
          }
        ],
        "cleanser": [
          {
            nama: "Gentle Foaming Cleanser",
            harga: "Rp 125.000",
            brand: "SkinQu Pure",
            deskripsi: "Pembersih wajah lembut pH-balanced",
            rating: 4.9,
            image: "https://via.placeholder.com/300x200/8b5cf6/ffffff?text=Cleanser+AI"
          }
        ],
        "moisturizer": [
          {
            nama: "Intense Moisture Cream",
            harga: "Rp 275.000",
            brand: "SkinQu Hydra",
            deskripsi: "Pelembab intensif 24 jam",
            rating: 4.8,
            image: "https://via.placeholder.com/300x200/0ea5e9/ffffff?text=Moisturizer+AI"
          }
        ]
      };
      
      finalProducts = fallbackProducts[requestData.category] || fallbackProducts.toner;
    }
    
    // Tambahkan data session ke produk untuk tracking
    const productsWithMeta = finalProducts.map(p => ({
      ...p,
      session_id: sessionId,
      scan_time: new Date().toISOString(),
      source: n8nResponse ? 'n8n_ai' : 'fallback_simulation'
    }));

    // ====================== SIMPAN DAN LANJUTKAN ======================
    // 9. Hentikan timer
    clearInterval(progressInterval);
    
    // 10. Simpan data ke sessionStorage
    sessionStorage.setItem("skinqu_products", JSON.stringify(productsWithMeta));
    sessionStorage.setItem("skinqu_scan_time", new Date().toISOString());
    sessionStorage.setItem("skinqu_session_id", sessionId);
    sessionStorage.setItem("skinqu_scan_category", requestData.category);
    
    // Tambahkan log untuk debug
    console.log("üíæ Data disimpan ke sessionStorage:", {
      sessionId,
      productCount: productsWithMeta.length,
      source: productsWithMeta[0]?.source
    });

    // 11. Update UI bahwa proses selesai
    updateLoadingStep(4, "‚úÖ Analisis selesai! Mengarahkan...");
    
    // Tampilkan konfirmasi sukses
    const loadingText = document.querySelector('.loading-text');
    const loadingSubtext = document.querySelector('.loading-subtext');
    
    if (loadingText) loadingText.textContent = "Analisis Berhasil!";
    if (loadingSubtext) {
      const sourceMsg = n8nResponse ? "dari AI n8n" : "dari sistem (n8n timeout)";
      loadingSubtext.textContent = `Ditemukan ${productsWithMeta.length} produk ${sourceMsg}`;
    }
    
    await new Promise(r => setTimeout(r, 1500));

    // 12. Redirect ke halaman produk dengan parameter
    window.location.href = `product.html?fromScan=true&session=${sessionId}&source=${productsWithMeta[0]?.source}`;

  } catch (err) {
    console.error("‚ùå Scan error:", err);
    
    // Hentikan timer
    if (progressInterval) clearInterval(progressInterval);
    
    // Tentukan pesan error yang lebih spesifik
    let errorMessage = "Gagal memproses analisis AI. ";
    let errorDetail = "";
    
    if (err.name === 'AbortError') {
      errorMessage = "Waktu koneksi ke server habis. ";
      errorDetail = "Server AI membutuhkan waktu lebih lama dari yang diharapkan.";
    } else if (err.message.includes('network') || err.message.includes('fetch')) {
      errorMessage = "Masalah jaringan. ";
      errorDetail = "Pastikan koneksi internet stabil dan coba lagi.";
    } else if (err.message.includes('tidak ada produk')) {
      errorMessage = "Tidak ada produk yang cocok. ";
      errorDetail = "Coba dengan kategori produk yang berbeda.";
    } else {
      errorDetail = err.message || "Terjadi kesalahan tidak terduga.";
    }
    
    // Tampilkan error di UI dengan detail
    const loadingText = document.querySelector('.loading-text');
    const loadingSubtext = document.querySelector('.loading-subtext');
    
    if (loadingText) loadingText.textContent = "‚ö†Ô∏è Proses Gagal";
    if (loadingSubtext) loadingSubtext.textContent = `${errorMessage}${errorDetail}`;
    
    // Tambahkan tombol coba lagi
    const loadingOverlay = document.getElementById('loadingOverlay');
    const retryBtn = document.createElement('button');
    retryBtn.innerHTML = "üîÑ Coba Scan Ulang";
    retryBtn.style.cssText = `
      margin-top: 20px;
      padding: 12px 24px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
    `;
    retryBtn.onclick = () => {
      loadingOverlay.style.display = "none";
      scanBtn.disabled = false;
      isProcessing = false;
      retryBtn.remove();
    };
    
    loadingOverlay.appendChild(retryBtn);
    
    // Auto reset setelah 10 detik
    setTimeout(() => {
      if (loadingOverlay.contains(retryBtn)) {
        loadingOverlay.removeChild(retryBtn);
      }
      loadingOverlay.style.display = "none";
      scanBtn.disabled = false;
      isProcessing = false;
    }, 10000);
    
    // Reset step descriptions
    updateLoadingStep(1, "Mengambil gambar wajah");
    document.querySelectorAll('.step-text').forEach((el, idx) => {
      const texts = ["Mengambil gambar wajah", "Mengirim ke server AI", 
                    "Analisis karakteristik kulit", "Menyiapkan rekomendasi"];
      if (idx < texts.length) el.textContent = texts[idx];
    });
  }
}

  // üéØ Events
  scanBtn.addEventListener('click', scanWajah);
  document.addEventListener('DOMContentLoaded', initCamera);
  
  // Handle halaman kembali
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      scanBtn.disabled = false;
      isProcessing = false;
      loadingOverlay.style.display = "none";
      if (progressInterval) clearInterval(progressInterval);
    }
  });
</script>
</body>
</html>