<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover"/>
  <title>SkinQu ‚Ä¢ AI Facial Scan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-glow: rgba(37, 99, 235, 0.4);
      --scan-line: #3b82f6;
      --glass-bg: rgba(15, 23, 42, 0.65);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text: #f1f5f9;
      --text-sub: #94a3b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      /* Prevent all scroll */
      overflow: hidden;
      height: 100%;
      touch-action: manipulation;
    }

    body {
      font-family: 'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(160deg, #0b0e1a, #111827, #0d1117);
      color: var(--text);
      min-height: 100dvh; /* dynamic viewport height */
      height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
      overflow: hidden;
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }

    body::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, transparent 40%, rgba(11, 14, 26, 0.9) 90%);
      z-index: -1;
      pointer-events: none;
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
      max-width: 360px;
    }

    .header h1 {
      font-weight: 700;
      font-size: clamp(24px, 5.5vw, 28px);
      letter-spacing: -0.5px;
      background: linear-gradient(100deg, #e2e8f0, #cbd5e1);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 6px;
    }

    .header p {
      font-size: clamp(14px, 3.8vw, 15px);
      color: var(--text-sub);
      line-height: 1.5;
    }

    .camera-frame {
      position: relative;
      width: 100%;
      max-width: 380px;
      aspect-ratio: 4/5;
      margin: 0 auto 24px;
      border-radius: clamp(20px, 5vw, 28px);
      overflow: hidden;
      background: #000;
      box-shadow:
        0 12px 30px rgba(0, 0, 0, 0.5),
        inset 0 0 0 1px var(--glass-border);
      isolation: isolate;
      flex-shrink: 0;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
      transform: scaleX(-1);
    }

    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 2;
    }

    .face-outline {
      width: 65%;
      max-width: 220px;
      filter: drop-shadow(0 0 8px var(--primary-glow));
    }

    .face-outline path {
      fill: none;
      stroke: var(--primary);
      stroke-width: 1.5;
      stroke-dasharray: 6, 4;
      stroke-linecap: round;
      opacity: 0.9;
      animation: pulse 3s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { stroke-dashoffset: 0; opacity: 0.7; }
      50% { stroke-dashoffset: -10; opacity: 0.95; }
    }

    .guide-text {
      position: absolute;
      top: 22%;
      font-size: clamp(12px, 3.2vw, 13px);
      color: rgba(255, 255, 255, 0.7);
      background: rgba(0, 0, 0, 0.25);
      padding: 4px 12px;
      border-radius: 20px;
      backdrop-filter: blur(6px);
    }

    .scan-line {
      position: absolute;
      top: -10px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--scan-line), transparent);
      box-shadow: 0 0 12px var(--primary-glow);
      opacity: 0;
      transform: scaleX(0.95);
      z-index: 3;
    }

    .flash {
      position: absolute;
      inset: 0;
      background: white;
      opacity: 0;
      z-index: 4;
      pointer-events: none;
    }

    #permission-msg {
      color: #94a3b8;
      font-size: clamp(15px, 4vw, 16px);
      text-align: center;
      padding: 32px 24px;
      line-height: 1.5;
    }

    .btn {
      width: 100%;
      max-width: 380px;
      padding: 16px;
      font-size: clamp(16px, 4.2vw, 17px);
      font-weight: 600;
      border: none;
      border-radius: 20px;
      background: linear-gradient(135deg, #447DCE, #447DCE);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow:
        0 4px 16px rgba(30, 64, 175, 0.3),
        0 0 0 2px rgba(59, 130, 246, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow:
        0 6px 20px rgba(30, 64, 175, 0.45),
        0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      transform: none;
      cursor: not-allowed;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100dvh;
      background: rgba(11, 14, 26, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      backdrop-filter: blur(10px);
      padding: 0 20px;
      box-sizing: border-box;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: clamp(16px, 4.5vw, 18px);
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      text-align: center;
    }

    .loading-subtext {
      color: var(--text-sub);
      font-size: clamp(13px, 3.6vw, 14px);
      max-width: 280px;
      text-align: center;
      line-height: 1.5;
    }

    .status-steps {
      margin-top: 24px;
      width: 100%;
      max-width: 300px;
    }

    .step {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
      opacity: 0.5;
      transition: opacity 0.3s ease;
    }

    .step.active {
      opacity: 1;
    }

    .step-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-size: 11px;
    }

    .step.active .step-icon {
      background: var(--primary);
    }

    .step-text {
      font-size: clamp(13px, 3.5vw, 14px);
      color: var(--text-sub);
    }

    .step.active .step-text {
      color: var(--text);
      font-weight: 500;
    }

    .note {
      font-size: clamp(10px, 2.8vw, 11px);
      color: #64748b;
      margin-top: auto;
      padding-top: 16px;
      max-width: 380px;
      line-height: 1.5;
      text-align: center;
    }

    .particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.4);
      animation: float 15s infinite linear;
    }

    @keyframes float {
      to { 
        transform: translateY(-100dvh) translateX(100px); 
        opacity: 0; 
      }
    }

    /* Mobile optimizations */
    @media (max-width: 375px) {
      .camera-frame { border-radius: 22px; }
      .header h1 { font-size: 25px; }
    }

    @media (max-width: 320px) {
      .header h1 { font-size: 23px; }
      .header p { font-size: 14px; }
      .btn { padding: 14px; font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>SkinQu AI Scanner</h1>
    <p>Lakukan pemindaian wajah real-time untuk rekomendasi perawatan kulit personal.</p>
  </div>

  <div class="camera-frame">
    <div id="permission-msg">üîç Mengaktifkan kamera‚Ä¶</div>
    <video id="video" playsinline muted></video>
    
    <div class="overlay">
      <div class="guide-text">Letakkan wajah di dalam garis</div>
      <svg class="face-outline" viewBox="0 0 100 130" xmlns="http://www.w3.org/2000/svg">
        <path d="M50,15 
                 C30,15 18,28 18,46 
                 C18,58 24,70 34,82 
                 C30,88 28,96 28,104 
                 C28,112 32,118 38,122 
                 C44,126 56,126 62,122 
                 C68,118 72,112 72,104 
                 C72,96 70,88 66,82 
                 C76,70 82,58 82,46 
                 C82,28 70,15 50,15 Z
                 
                 M38,48 
                 C38,48 42,44 50,44 
                 C58,44 62,48 62,48 
                 
                 M44,90 
                 Q50,96 56,90" />
      </svg>
    </div>

    <div class="scan-line" id="scanLine"></div>
    <div class="flash" id="flash"></div>
    <div class="particles" id="particles"></div>
  </div>

  <button id="scanBtn" class="btn" disabled>
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="3"></circle>
      <path d="M12 3v2"></path>
      <path d="M12 19v2"></path>
      <path d="M5 12h2"></path>
      <path d="M17 12h2"></path>
      <path d="M7 7l1.5 1.5"></path>
      <path d="M15.5 15.5L17 17"></path>
      <path d="M17 7l-1.5 1.5"></path>
      <path d="M8.5 15.5L7 17"></path>
    </svg>
    Mulai Pemindaian
  </button>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Memproses analisis wajah</div>
    <div class="loading-subtext">AI kami sedang menganalisis kulit dan mencari produk terbaik untuk Anda</div>
    
    <div class="status-steps">
      <div class="step active" id="step1">
        <div class="step-icon">1</div>
        <div class="step-text">Mengambil gambar wajah</div>
      </div>
      <div class="step" id="step2">
        <div class="step-icon">2</div>
        <div class="step-text">Mengirim ke server AI</div>
      </div>
      <div class="step" id="step3">
        <div class="step-icon">3</div>
        <div class="step-text">Analisis karakteristik kulit</div>
      </div>
      <div class="step" id="step4">
        <div class="step-icon">4</div>
        <div class="step-text">Menyiapkan rekomendasi</div>
      </div>
    </div>
  </div>

  <div class="note">
    üîí Data tidak disimpan. Analisis dilakukan lokal & cloud aman. Bukan diagnosis medis.
  </div>

  <canvas id="canvas" hidden></canvas>

  <script>
  // Clean URL: removed trailing space
  const N8N_WEBHOOK = "https://aang34.app.n8n.cloud/webhook/scan-wajah";

  const video = document.getElementById('video');
  const scanBtn = document.getElementById('scanBtn');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const permissionMsg = document.getElementById('permission-msg');
  const scanLine = document.getElementById('scanLine');
  const flashEl = document.getElementById('flash');
  const particlesContainer = document.getElementById('particles');

  let isProcessing = false;

  function createParticles() {
    for (let i = 0; i < 12; i++) {
      const p = document.createElement('div');
      p.classList.add('particle');
      p.style.left = `${Math.random() * 100}%`;
      p.style.top = `${100 + Math.random() * 20}%`;
      p.style.animationDuration = `${10 + Math.random() * 20}s`;
      p.style.opacity = Math.random() * 0.5 + 0.2;
      p.style.width = `${2 + Math.random() * 3}px`;
      p.style.height = p.style.width;
      particlesContainer.appendChild(p);
    }
  }

  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'user',
          width: { ideal: 720 },
          height: { ideal: 960 }
        },
        audio: false
      });

      video.srcObject = stream;
      video.style.display = 'block';
      permissionMsg.style.display = 'none';

      video.onloadedmetadata = () => {
        video.play().catch(e => console.warn("Autoplay prevented:", e));
      };
      scanBtn.disabled = false;

      createParticles();
    } catch (err) {
      console.error("Camera error:", err);
      permissionMsg.innerHTML = `‚ö†Ô∏è Akses kamera dibutuhkan.<br><small>Buka pengaturan ‚Üí izinkan kamera ‚Üí refresh halaman.</small>`;
    }
  }

  function runScanAnimation() {
    return new Promise(resolve => {
      scanLine.style.opacity = '0';
      scanLine.style.top = '-10px';
      scanLine.style.transition = 'none';

      setTimeout(() => {
        scanLine.style.transition = 'top 1.8s ease-out, opacity 0.3s';
        scanLine.style.opacity = '1';
        scanLine.style.top = '100%';
      }, 100);

      setTimeout(() => {
        flashEl.style.transition = 'opacity 0.4s';
        flashEl.style.opacity = '0.8';
        setTimeout(() => {
          flashEl.style.opacity = '0';
          resolve();
        }, 200);
      }, 1700);
    });
  }

  function updateLoadingStep(stepNumber, description = '') {
    for (let i = 1; i <= 4; i++) {
      const step = document.getElementById(`step${i}`);
      step?.classList.remove('active');
    }
    
    for (let i = 1; i <= stepNumber; i++) {
      const step = document.getElementById(`step${i}`);
      step?.classList.add('active');
    }
    
    if (description && stepNumber <= 4) {
      const stepText = document.querySelector(`#step${stepNumber} .step-text`);
      if (stepText) stepText.textContent = description;
    }
  }

  async function scanWajah() {
    if (isProcessing) return;
    
    if (!video.srcObject) {
      alert("Kamera belum siap. Tunggu sebentar‚Ä¶");
      return;
    }

    scanBtn.disabled = true;
    isProcessing = true;
    loadingOverlay.style.display = "flex";
    updateLoadingStep(1, "Mengambil gambar wajah...");

    try {
      await runScanAnimation();
      await new Promise(r => setTimeout(r, 300));

      updateLoadingStep(2, "Mengolah gambar...");
      
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const size = Math.min(video.videoWidth, video.videoHeight);
      const x = (video.videoWidth - size) / 2;
      const y = (video.videoHeight - size) / 2;

      canvas.width = 512;
      canvas.height = 512;
      ctx.drawImage(video, x, y, size, size, 0, 0, 512, 512);
      const imageBase64 = canvas.toDataURL('image/jpeg', 0.72);

      updateLoadingStep(3, "Mengirim ke AI...");
      
      const response = await fetch(N8N_WEBHOOK, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ image: imageBase64 })
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const products = await response.json();
      updateLoadingStep(4, "AI menganalisis (25 detik)...");

      let seconds = 0;
      const timerInterval = setInterval(() => {
        seconds++;
        document.querySelector('.loading-subtext').textContent = 
          `AI sedang bekerja: ${seconds} detik‚Ä¶`;
      }, 1000);

      await new Promise(r => setTimeout(r, 25000));
      clearInterval(timerInterval);

      sessionStorage.setItem("skinqu_products", JSON.stringify(products || []));
      sessionStorage.setItem("skinqu_scan_time", new Date().toISOString());
      
      window.location.href = "product.html";

    } catch (err) {
      console.error("‚ùå Error:", err);
      
      // Clear all intervals
      let id = window.setTimeout(() => {}, 0);
      while (id--) window.clearTimeout(id);

      loadingOverlay.style.display = "none";
      scanBtn.disabled = false;
      isProcessing = false;
      
      alert("Gagal memindai: " + (err.message || "Coba lagi nanti."));
    }
  }

  scanBtn.addEventListener('click', scanWajah);
  document.addEventListener('DOMContentLoaded', initCamera);
  
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      scanBtn.disabled = false;
      isProcessing = false;
      loadingOverlay.style.display = "none";
    }
  });
  </script>
</body>
</html>